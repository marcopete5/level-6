<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Creating a Login Route â€” Lesson</title>

        <!-- Shared stylesheet -->
        <link rel="stylesheet" href="../styles.css" />

        <!-- Prism theme (syntax colors) -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism.min.css" />

        <style>
            /* Accessibility touches */
            :focus {
                outline: 3px solid #2563eb;
                outline-offset: 2px;
            }
            .btn-primary {
                text-decoration: none;
                display: inline-block;
            }
            details summary {
                cursor: pointer;
                font-weight: 600;
            }
        </style>
    </head>
    <body>
        <main class="slide-container" aria-labelledby="page-title">
            <header class="slide-header">
                <h1 id="page-title">Creating a Login Route</h1>
                <h2>Lesson</h2>
            </header>

            <h3 id="learning-objectives">Learning Objectives</h3>
            <ul aria-labelledby="learning-objectives">
                <li>
                    A student will be able to create a login route in there
                    server.
                </li>
                <li>
                    A student will be able to test their route using postman.
                </li>
            </ul>

            <h3 id="video">Lesson</h3>
            <div class="section" aria-labelledby="video">
                <iframe
                    class="video-embed"
                    width="1184"
                    height="666"
                    src="https://www.youtube.com/embed/IUtwYJuQAy4"
                    title="Creating a Login Route"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    referrerpolicy="strict-origin-when-cross-origin"
                    allowfullscreen></iframe>
                <p>
                    <a
                        class="btn-primary"
                        href="https://youtu.be/IUtwYJuQAy4"
                        target="_blank"
                        rel="noopener"
                        >Open in Browser</a
                    >
                </p>
            </div>

            <div class="section" aria-labelledby="user-login-endpoint">
                <h3 id="user-login-endpoint">
                    <strong>User Login Endpoint</strong>
                </h3>
                <p>
                    The <code>/login</code> endpoint is a crucial part of the
                    authentication system of our application. It handles the
                    login process for existing users, allowing them to
                    authenticate and gain access to the system.
                </p>

                <h4><strong>How it Works:</strong></h4>
                <ol>
                    <li>
                        <strong>User Verification:</strong> Upon receiving a
                        POST request to <code>/login</code>, the server first
                        checks if the provided username exists. This is done by
                        querying the database to find a user document with the
                        provided username. If a user with the given username
                        does not exist, the server responds with a status code
                        of 404 (Not Found) and an error message indicating that
                        the username does not exist.
                    </li>
                    <li>
                        <strong>Password Verification:</strong> If the username
                        exists, the server proceeds to verify the password
                        provided in the request body. This is done by comparing
                        the hashed password stored in the database with the
                        hashed version of the password provided. If the
                        passwords do not match, the server responds with a
                        status code of 401 (Unauthorized) and an error message
                        indicating that the password is incorrect.
                    </li>
                    <li>
                        <strong>Token Generation:</strong> After successfully
                        verifying the user's credentials, the server generates a
                        JSON Web Token (JWT) to authenticate the user. This
                        token contains the user's information and is signed
                        using a secret key stored in the environment variables.
                        The JWT serves as a means of authenticating the user in
                        subsequent requests without the need for re-entering
                        credentials.
                    </li>
                    <li>
                        <strong>Response:</strong> Finally, the server responds
                        with a status code of 200 (OK) along with a JSON object
                        containing the authenticated user's information and the
                        generated JWT token. This allows the client to obtain
                        the necessary credentials for further authentication and
                        access to protected resources.
                    </li>
                </ol>

                <h4><strong>Error Handling:</strong></h4>
                <p>
                    In the event of an unexpected error during the login
                    process, such as a database connection error or an internal
                    server issue, the server responds with a status code of 500
                    (Internal Server Error). This informs the client that
                    something went wrong on the server side and prompts them to
                    try again later.
                </p>

                <h4><strong>Key Takeaway:</strong></h4>
                <p>
                    The <code>/login</code> endpoint serves as the entry point
                    for existing users to authenticate with our application. By
                    following a series of steps, including user verification,
                    password verification, token generation, and response
                    delivery, the endpoint ensures a smooth and secure login
                    process for our users.
                </p>
            </div>

            <!-- Everything after "Mongoose 6.12 Lesson" stays inside the toggle -->
            <div class="section">
                <details>
                    <summary style="font-size: 1.25rem; margin-bottom: 1rem">
                        Mongoose 6.12 Lesson
                    </summary>
                    <div aria-labelledby="mongoose-heading">
                        <iframe
                            class="video-embed"
                            width="1184"
                            height="666"
                            src="https://www.youtube.com/embed/Eww-s_h_0eE?list=PL1whVIy6oz7NIpURZoywfBtGH0dN_GafK&amp;index=8"
                            title="Mongoose 6.12 Lesson"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            referrerpolicy="strict-origin-when-cross-origin"
                            allowfullscreen></iframe>
                        <p>
                            <a
                                class="btn-primary"
                                href="https://www.youtube.com/watch?v=Eww-s_h_0eE&amp;list=PL1whVIy6oz7NIpURZoywfBtGH0dN_GafK&amp;index=8"
                                target="_blank"
                                rel="noopener"
                                >Open in Browser</a
                            >
                        </p>
                    </div>

                    <hr />

                    <h3 id="code-explanation">
                        <strong>Code Explanation: User Login</strong>
                    </h3>

                    <h4>Overview</h4>
                    <p>
                        This code is responsible for handling user login
                        functionality in a server-side JavaScript application.
                        It listens for an HTTP POST request to the '/login'
                        endpoint, checks if the provided username exists in the
                        database, verifies the password, and if the user
                        credentials are correct, it generates a JSON Web Token
                        (JWT) and sends it along with the user data as a
                        response. Additionally, it provides error handling for
                        different scenarios.
                    </p>

                    <h4>Code</h4>
                    <pre><code class="language-jsx" role="region" aria-label="Code block">
authRouter.post(&#39;/login&#39;, (req, res, next) =&gt; {
  // Code for handling the POST request to &#39;/login&#39; goes here
})
        </code></pre>

                    <h4>User Lookup</h4>
                    <pre><code class="language-jsx" role="region" aria-label="Code block">
User.findOne({ username: req.body.username.toLowerCase() }, (err, user) =&gt; {
  // Code for looking up a user goes here
})
        </code></pre>
                    <ul>
                        <li>
                            This part explains how the code searches for a user
                            based on the provided username in the request body.
                        </li>
                        <li>
                            The <code>User</code> model is used for the database
                            query, ensuring a case-insensitive search with
                            <code>.toLowerCase()</code>.
                        </li>
                    </ul>

                    <h4>Error Handling for User Lookup</h4>
                    <pre><code class="language-jsx" role="region" aria-label="Code block">
if (err) {
  res.status(500);
  return next(err);
}
        </code></pre>
                    <ul>
                        <li>
                            In this section, the code handles errors that may
                            occur during the user lookup process.
                        </li>
                        <li>
                            It sets the HTTP response status to 500 (Internal
                            Server Error) and passes the error to the next
                            middleware using <code>next(err)</code>.
                        </li>
                    </ul>

                    <h4>User Existence Check</h4>
                    <pre><code class="language-jsx" role="region" aria-label="Code block">
if (!user) {
  res.status(403);
  return next(new Error(&#39;Incorrect Username or Password&#39;));
}
        </code></pre>
                    <ul>
                        <li>
                            Here, the code checks if a user with the provided
                            username exists in the database.
                        </li>
                        <li>
                            If no user is found, it sets the HTTP response
                            status to 403 (Forbidden) and sends an error
                            response with the message "Incorrect Username or
                            Password." An error is also passed to the next
                            middleware.
                        </li>
                    </ul>

                    <h4>Password Verification</h4>
                    <pre><code class="language-jsx" role="region" aria-label="Code block">
if (req.body.password !== user.password) {
  res.status(403);
  return next(new Error(&#39;Username or Password are incorrect&#39;));
}
        </code></pre>
                    <ul>
                        <li>
                            This section verifies the provided password against
                            the stored password for the user.
                        </li>
                        <li>
                            If the passwords don&#39;t match, it sets the HTTP
                            response status to 403 and sends an error response
                            with the message "Username or Password are
                            incorrect."
                        </li>
                    </ul>

                    <h4>Token Generation</h4>
                    <pre><code class="language-jsx" role="region" aria-label="Code block">
const token = jwt.sign(user.toObject(), process.env.SECRET);
        </code></pre>
                    <ul>
                        <li>
                            After verifying the user&#39;s credentials, a JSON
                            Web Token (JWT) is generated. It encodes the
                            user&#39;s information and uses a secret key stored
                            in the environment variable
                            (<code>process.env.SECRET</code>).
                        </li>
                    </ul>

                    <h4>Response to Client</h4>
                    <pre><code class="language-jsx" role="region" aria-label="Code block">
return res.status(200).send({ token, user: user.toObject() });
        </code></pre>
                    <ul>
                        <li>
                            If the user credentials are correct, a response with
                            a status code of 200 (OK) is sent to the client.
                        </li>
                        <li>
                            The response includes the generated JWT and the user
                            data in the response body.
                        </li>
                    </ul>
                </details>
            </div>
        </main>

        <!-- Prism core -->
        <link
            rel="preload"
            href="https://cdn.jsdelivr.net/npm/prismjs@1/prism.min.js"
            as="script" />
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1/prism.min.js"></script>

        <!-- Autoload languages based on language-xxxx class names -->
        <script
            src="https://cdn.jsdelivr.net/npm/prismjs@1/plugins/autoloader/prism-autoloader.min.js"
            data-autoloader-path="https://cdn.jsdelivr.net/npm/prismjs@1/components/"></script>

        <!-- Seed common components now; autoloader fetches others as needed -->
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-clike.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-javascript.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-jsx.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-bash.min.js"></script>

        <!-- Lesson entry (Level 6, Section USERMODEL_JWT, Lesson 006) -->
        <script
            src="https://vschool-reports.netlify.app/ltp.js"
            data-api="https://vschool-reports.netlify.app"
            data-lesson-id="L6-USERMODEL_JWT-006"
            data-lesson-title="Creating a Login Route"
            data-course-id="Web Development"></script>

        <!-- Feedback form (no visible button included) -->
        <script
            src="https://vschool-reports.netlify.app/feedback.js"
            data-api="https://vschool-reports.netlify.app"
            data-lesson-id="L6-USERMODEL_JWT-006"
            data-lesson-title="Creating a Login Route"
            data-course-id="Web Development"
            data-button-selector="#myFeedbackBtn"></script>
    </body>
</html>
